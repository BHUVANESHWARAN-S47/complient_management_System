<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Smart Complaint Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <div class="bg-gradient-to-r from-purple-600 to-indigo-700 text-white font-bold text-xl p-2 rounded-lg">
                            <i class="fas fa-user-shield"></i> SC
                        </div>
                        <h1 class="text-xl font-bold text-gray-800">Admin Dashboard</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button class="p-2 text-gray-600 hover:text-gray-900 rounded-full hover:bg-gray-100">
                            <i class="fas fa-bell"></i>
                        </button>
                        <div class="relative">
                            <button class="flex items-center space-x-2 focus:outline-none" id="userMenuButton">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-indigo-600 flex items-center justify-center text-white font-bold">
                                    <i class="fas fa-user-shield"></i>
                                </div>
                                <span class="text-gray-700 font-medium hidden md:inline" id="adminName">Administrator</span>
                                <i class="fas fa-chevron-down text-gray-500 hidden md:inline"></i>
                            </button>
                        </div>
                        <button id="logoutBtn" class="ml-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-2 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition duration-300">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex flex-1">
            <!-- Sidebar -->
            <aside class="w-64 bg-white shadow-md hidden md:block">
                <nav class="p-4">
                    <ul class="space-y-2">
                        <li>
                            <a href="#" class="flex items-center space-x-3 p-3 rounded-lg bg-purple-50 text-purple-600 font-medium" data-section="overview">
                                <i class="fas fa-home"></i>
                                <span>Dashboard Overview</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100" data-section="users">
                                <i class="fas fa-users"></i>
                                <span>User Management</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100" data-section="complaints">
                                <i class="fas fa-inbox"></i>
                                <span>All Complaints</span>
                            </a>
                        </li>
                        <li>
                            <a href="spam.html" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-filter"></i>
                                <span>Spam Filtering</span>
                            </a>
                        </li>
                        <li>
                            <a href="classification.html" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-tags"></i>
                                <span>Classification</span>
                            </a>
                        </li>
                        <li>
                            <a href="recurrence.html" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-recycle"></i>
                                <span>Recurrence Detection</span>
                            </a>
                        </li>
                        <li>
                            <a href="routing.html" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-route"></i>
                                <span>Routing & Escalation</span>
                            </a>
                        </li>
                        <li>
                            <a href="reports.html" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-chart-bar"></i>
                                <span>Reports</span>
                            </a>
                        </li>
                        <li>
                            <a href="analytics.html" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-chart-line"></i>
                                <span>Analytics</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100" data-section="feedback">
                                <i class="fas fa-comments"></i>
                                <span>Feedback Analysis</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100" data-section="volunteers">
                                <i class="fas fa-hands-helping"></i>
                                <span>Volunteer Management</span>
                            </a>
                        </li>
                        <li>
                            <a href="settings.html" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-cog"></i>
                                <span>Settings</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </aside>

            <!-- Main Dashboard Content -->
            <main class="flex-1 p-6 overflow-auto">
                <!-- Overview Section -->
                <div id="overviewSection">
                    <div class="mb-8">
                        <h1 class="text-2xl font-bold text-gray-800">Dashboard Overview</h1>
                        <p class="text-gray-600">Complete system visibility and control</p>
                    </div>

                    <!-- Metrics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl shadow-xl p-6 transform transition duration-300 hover:scale-105">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-blue-100">Total Complaints</p>
                                    <p class="text-3xl font-bold mt-2" id="totalComplaints">0</p>
                                </div>
                                <div class="p-3 rounded-full bg-blue-400 bg-opacity-30">
                                    <i class="fas fa-inbox text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-2xl shadow-xl p-6 transform transition duration-300 hover:scale-105">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-green-100">Total Users</p>
                                    <p class="text-3xl font-bold mt-2" id="totalUsers">0</p>
                                </div>
                                <div class="p-3 rounded-full bg-green-400 bg-opacity-30">
                                    <i class="fas fa-users text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-2xl shadow-xl p-6 transform transition duration-300 hover:scale-105">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-purple-100">Active Volunteers</p>
                                    <p class="text-3xl font-bold mt-2" id="activeVolunteers">0</p>
                                </div>
                                <div class="p-3 rounded-full bg-purple-400 bg-opacity-30">
                                    <i class="fas fa-hands-helping text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white rounded-2xl shadow-xl p-6 transform transition duration-300 hover:scale-105">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-yellow-100">Avg. Feedback Rating</p>
                                    <p class="text-3xl font-bold mt-2" id="avgFeedbackRating">0.0</p>
                                </div>
                                <div class="p-3 rounded-full bg-yellow-400 bg-opacity-30">
                                    <i class="fas fa-star text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Access Modules -->
                    <div class="bg-white rounded-2xl shadow p-6 mb-8">
                        <h2 class="text-xl font-bold text-gray-800 mb-6">Quick Access to All Features</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <a href="spam.html" class="bg-gradient-to-br from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 p-5 rounded-xl text-center transition duration-300 border border-blue-200">
                                <div class="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center text-white mx-auto mb-3">
                                    <i class="fas fa-filter"></i>
                                </div>
                                <div class="text-blue-700 font-bold">Spam Filtering</div>
                            </a>
                            <a href="classification.html" class="bg-gradient-to-br from-yellow-50 to-yellow-100 hover:from-yellow-100 hover:to-yellow-200 p-5 rounded-xl text-center transition duration-300 border border-yellow-200">
                                <div class="w-12 h-12 rounded-full bg-yellow-500 flex items-center justify-center text-white mx-auto mb-3">
                                    <i class="fas fa-tags"></i>
                                </div>
                                <div class="text-yellow-700 font-bold">Classification</div>
                            </a>
                            <a href="recurrence.html" class="bg-gradient-to-br from-purple-50 to-purple-100 hover:from-purple-100 hover:to-purple-200 p-5 rounded-xl text-center transition duration-300 border border-purple-200">
                                <div class="w-12 h-12 rounded-full bg-purple-500 flex items-center justify-center text-white mx-auto mb-3">
                                    <i class="fas fa-recycle"></i>
                                </div>
                                <div class="text-purple-700 font-bold">Recurrence Detection</div>
                            </a>
                            <a href="routing.html" class="bg-gradient-to-br from-red-50 to-red-100 hover:from-red-100 hover:to-red-200 p-5 rounded-xl text-center transition duration-300 border border-red-200">
                                <div class="w-12 h-12 rounded-full bg-red-500 flex items-center justify-center text-white mx-auto mb-3">
                                    <i class="fas fa-route"></i>
                                </div>
                                <div class="text-red-700 font-bold">Routing & Escalation</div>
                            </a>
                            <a href="reports.html" class="bg-gradient-to-br from-indigo-50 to-indigo-100 hover:from-indigo-100 hover:to-indigo-200 p-5 rounded-xl text-center transition duration-300 border border-indigo-200">
                                <div class="w-12 h-12 rounded-full bg-indigo-500 flex items-center justify-center text-white mx-auto mb-3">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <div class="text-indigo-700 font-bold">Reports</div>
                            </a>
                            <a href="analytics.html" class="bg-gradient-to-br from-pink-50 to-pink-100 hover:from-pink-100 hover:to-pink-200 p-5 rounded-xl text-center transition duration-300 border border-pink-200">
                                <div class="w-12 h-12 rounded-full bg-pink-500 flex items-center justify-center text-white mx-auto mb-3">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="text-pink-700 font-bold">Analytics</div>
                            </a>
                            <a href="#" class="bg-gradient-to-br from-green-50 to-green-100 hover:from-green-100 hover:to-green-200 p-5 rounded-xl text-center transition duration-300 border border-green-200 sidebar-link" data-section="feedback">
                                <div class="w-12 h-12 rounded-full bg-green-500 flex items-center justify-center text-white mx-auto mb-3">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <div class="text-green-700 font-bold">Feedback Analysis</div>
                            </a>
                            <a href="settings.html" class="bg-gradient-to-br from-teal-50 to-teal-100 hover:from-teal-100 hover:to-teal-200 p-5 rounded-xl text-center transition duration-300 border border-teal-200">
                                <div class="w-12 h-12 rounded-full bg-teal-500 flex items-center justify-center text-white mx-auto mb-3">
                                    <i class="fas fa-cog"></i>
                                </div>
                                <div class="text-teal-700 font-bold">Settings</div>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- User Management Section (Hidden initially) -->
                <div id="usersSection" class="hidden">
                    <div class="mb-8">
                        <h1 class="text-2xl font-bold text-gray-800">User Management</h1>
                        <p class="text-gray-600">Manage all system users and their roles</p>
                    </div>

                    <div class="bg-white rounded-2xl shadow p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-gray-800">All Users</h2>
                            <button class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-indigo-700">
                                <i class="fas fa-plus mr-2"></i>Add User
                            </button>
                        </div>
                        <div id="usersTable">
                            <!-- Users will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Complaints Section (Hidden initially) -->
                <div id="complaintsSection" class="hidden">
                    <div class="mb-8">
                        <h1 class="text-2xl font-bold text-gray-800">All Complaints</h1>
                        <p class="text-gray-600">View and manage all system complaints</p>
                    </div>

                    <div class="bg-white rounded-2xl shadow p-6">
                        <div id="complaintsTable">
                            <!-- Complaints will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Feedback Analysis Section (Hidden initially) -->
                <div id="feedbackSection" class="hidden">
                    <div class="mb-8">
                        <h1 class="text-2xl font-bold text-gray-800">Feedback Analysis</h1>
                        <p class="text-gray-600">Comprehensive feedback insights and analytics</p>
                    </div>

                    <!-- Feedback Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow p-6">
                            <h3 class="text-gray-600 text-sm font-medium mb-2">Total Feedback</h3>
                            <p class="text-3xl font-bold text-gray-800" id="feedbackTotal">0</p>
                        </div>
                        <div class="bg-white rounded-xl shadow p-6">
                            <h3 class="text-gray-600 text-sm font-medium mb-2">Average Rating</h3>
                            <p class="text-3xl font-bold text-gray-800" id="feedbackAvgRating">0.0</p>
                            <div class="flex mt-2" id="feedbackStars"></div>
                        </div>
                        <div class="bg-white rounded-xl shadow p-6">
                            <h3 class="text-gray-600 text-sm font-medium mb-2">Feedback Rate</h3>
                            <p class="text-3xl font-bold text-gray-800" id="feedbackRate">0%</p>
                        </div>
                    </div>

                    <!-- Sentiment Distribution -->
                    <div class="bg-white rounded-xl shadow p-6 mb-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Sentiment Distribution</h3>
                        <div class="grid grid-cols-3 gap-4" id="sentimentDistribution">
                            <!-- Sentiment data will be loaded here -->
                        </div>
                    </div>

                    <!-- Recent Feedback -->
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Feedback</h3>
                        <div id="feedbackList">
                            <!-- Feedback list will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Volunteer Management Section (Hidden initially) -->
                <div id="volunteersSection" class="hidden">
                    <div class="mb-8">
                        <h1 class="text-2xl font-bold text-gray-800">Volunteer Management</h1>
                        <p class="text-gray-600">Review and manage volunteer applications</p>
                    </div>

                    <!-- Pending Applications -->
                    <div class="bg-white rounded-2xl shadow p-6 mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-clock text-yellow-500 mr-2"></i>Pending Applications
                            <span id="pendingCount" class="ml-2 px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm">0</span>
                        </h3>
                        <div id="pendingApplications" class="space-y-4">
                            <!-- Pending applications will be loaded here -->
                        </div>
                    </div>

                    <!-- Approved Volunteers -->
                    <div class="bg-white rounded-2xl shadow p-6 mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>Approved Volunteers
                            <span id="approvedCount" class="ml-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">0</span>
                        </h3>
                        <div id="approvedVolunteers" class="space-y-3">
                            <!-- Approved volunteers will be loaded here -->
                        </div>
                    </div>

                    <!-- Rejected Applications -->
                    <div class="bg-white rounded-2xl shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-times-circle text-red-500 mr-2"></i>Rejected Applications
                            <span id="rejectedCount" class="ml-2 px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm">0</span>
                        </h3>
                        <div id="rejectedApplications" class="space-y-3">
                            <!-- Rejected applications will be loaded here -->
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200 p-4">
            <div class="container mx-auto text-center text-gray-600 text-sm">
                <p>&copy; 2025 Smart Complaint Portal. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:8000';

        // Check authentication
        const token = localStorage.getItem('token');
        const userRole = localStorage.getItem('userRole');
        const username = localStorage.getItem('username');
        const fullName = localStorage.getItem(`userFullName_${username}`);

        if (!token || userRole !== 'admin') {
            window.location.href = 'login.html';
        }

        // Set admin name
        document.getElementById('adminName').textContent = fullName || 'Administrator';

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.clear();
            window.location.href = 'login.html';
        });

        // Section navigation
        const sidebarLinks = document.querySelectorAll('.sidebar-link[data-section]');
        const sections = {
            overview: document.getElementById('overviewSection'),
            users: document.getElementById('usersSection'),
            complaints: document.getElementById('complaintsSection'),
            feedback: document.getElementById('feedbackSection'),
            volunteers: document.getElementById('volunteersSection')
        };

        sidebarLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.dataset.section;
                showSection(section);
            });
        });

        function showSection(sectionName) {
            // Hide all sections
            Object.values(sections).forEach(section => {
                section.classList.add('hidden');
            });

            // Show selected section
            if (sections[sectionName]) {
                sections[sectionName].classList.remove('hidden');
            }

            // Update sidebar active state
            document.querySelectorAll('.sidebar-link, aside a').forEach(link => {
                link.classList.remove('bg-purple-50', 'text-purple-600', 'font-medium');
                link.classList.add('text-gray-700');
            });

            const activeLink = document.querySelector(`[data-section="${sectionName}"]`);
            if (activeLink) {
                activeLink.classList.add('bg-purple-50', 'text-purple-600', 'font-medium');
                activeLink.classList.remove('text-gray-700');
            }

            // Load section data
            loadSectionData(sectionName);
        }

        async function loadSectionData(sectionName) {
            switch(sectionName) {
                case 'overview':
                    await loadDashboardMetrics();
                    break;
                case 'users':
                    await loadUsers();
                    break;
                case 'complaints':
                    await loadComplaints();
                    break;
                case 'feedback':
                    await loadFeedbackAnalysis();
                    break;
                case 'volunteers':
                    await loadVolunteerRequests();
                    break;
            }
        }

        // Load dashboard metrics
        async function loadDashboardMetrics() {
            try {
                const headers = {
                    'Authorization': `Bearer ${token}`
                };

                // Load users
                const usersResponse = await fetch(`${API_BASE_URL}/api/admin/users`, { headers });
                const users = await usersResponse.json();
                
                document.getElementById('totalUsers').textContent = users.length;
                
                const volunteers = users.filter(u => u.role === 'volunteer' && u.volunteer_status === 'active');
                document.getElementById('activeVolunteers').textContent = volunteers.length;

                // Load complaints
                const complaintsResponse = await fetch(`${API_BASE_URL}/api/admin/complaints`, { headers });
                const complaints = await complaintsResponse.json();
                document.getElementById('totalComplaints').textContent = complaints.length;

                // Load feedback overview
                const feedbackResponse = await fetch(`${API_BASE_URL}/api/admin/feedback/overview`, { headers });
                const feedbackData = await feedbackResponse.json();
                document.getElementById('avgFeedbackRating').textContent = feedbackData.average_rating.toFixed(1);

            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const users = await response.json();

                const table = document.getElementById('usersTable');
                table.innerHTML = `
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3">Name</th>
                                <th class="text-left py-3">Email</th>
                                <th class="text-left py-3">Role</th>
                                <th class="text-left py-3">Status</th>
                                <th class="text-left py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="py-3">${user.full_name}</td>
                                    <td class="py-3">${user.email}</td>
                                    <td class="py-3">
                                        <span class="px-2 py-1 text-xs rounded-full ${getRoleBadgeClass(user.role)}">
                                            ${user.role.toUpperCase()}
                                        </span>
                                    </td>
                                    <td class="py-3">${user.volunteer_status || 'N/A'}</td>
                                    <td class="py-3">
                                        <button class="text-blue-600 hover:text-blue-800 mr-2">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load complaints
        async function loadComplaints() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/complaints`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const complaints = await response.json();

                const table = document.getElementById('complaintsTable');
                table.innerHTML = `
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3">ID</th>
                                <th class="text-left py-3">Title</th>
                                <th class="text-left py-3">Category</th>
                                <th class="text-left py-3">Submitted By</th>
                                <th class="text-left py-3">Date</th>
                                <th class="text-left py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${complaints.map(c => `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="py-3">${c.complaint_id.substring(0, 8)}...</td>
                                    <td class="py-3">${c.title}</td>
                                    <td class="py-3">${c.category}</td>
                                    <td class="py-3">${c.citizen_name || 'N/A'}</td>
                                    <td class="py-3">${new Date(c.created_at).toLocaleDateString()}</td>
                                    <td class="py-3">
                                        <button class="text-blue-600 hover:text-blue-800">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading complaints:', error);
            }
        }

        // Load feedback analysis
        async function loadFeedbackAnalysis() {
            try {
                const overviewResponse = await fetch(`${API_BASE_URL}/api/admin/feedback/overview`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const overview = await overviewResponse.json();

                document.getElementById('feedbackTotal').textContent = overview.total_feedback;
                document.getElementById('feedbackAvgRating').textContent = overview.average_rating.toFixed(1);
                document.getElementById('feedbackRate').textContent = `${overview.feedback_rate}%`;

                // Render stars
                const starsContainer = document.getElementById('feedbackStars');
                const fullStars = Math.floor(overview.average_rating);
                const hasHalfStar = overview.average_rating % 1 >= 0.5;
                
                let starsHTML = '';
                for (let i = 0; i < fullStars; i++) {
                    starsHTML += '<i class="fas fa-star text-yellow-400"></i>';
                }
                if (hasHalfStar) {
                    starsHTML += '<i class="fas fa-star-half-alt text-yellow-400"></i>';
                }
                starsContainer.innerHTML = starsHTML;

                // Sentiment distribution
                const sentimentDiv = document.getElementById('sentimentDistribution');
                const dist = overview.sentiment_distribution;
                sentimentDiv.innerHTML = `
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <i class="fas fa-smile text-3xl text-green-500 mb-2"></i>
                        <p class="text-2xl font-bold text-gray-800">${dist.positive}</p>
                        <p class="text-sm text-gray-600">Positive</p>
                    </div>
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <i class="fas fa-meh text-3xl text-gray-500 mb-2"></i>
                        <p class="text-2xl font-bold text-gray-800">${dist.neutral}</p>
                        <p class="text-sm text-gray-600">Neutral</p>
                    </div>
                    <div class="text-center p-4 bg-red-50 rounded-lg">
                        <i class="fas fa-frown text-3xl text-red-500 mb-2"></i>
                        <p class="text-2xl font-bold text-gray-800">${dist.negative}</p>
                        <p class="text-sm text-gray-600">Negative</p>
                    </div>
                `;

                // Load feedback list
                const listResponse = await fetch(`${API_BASE_URL}/api/admin/feedback/list`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const feedbackData = await listResponse.json();
                
                const feedbackList = document.getElementById('feedbackList');
                if (feedbackData.feedback.length === 0) {
                    feedbackList.innerHTML = '<p class="text-gray-500 text-center py-8">No feedback yet</p>';
                } else {
                    feedbackList.innerHTML = feedbackData.feedback.slice(0, 5).map(f => `
                        <div class="border-b py-4 last:border-0">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex">
                                    ${Array(f.rating).fill('<i class="fas fa-star text-yellow-400"></i>').join('')}
                                </div>
                                <span class="text-sm text-gray-500">${new Date(f.created_at).toLocaleDateString()}</span>
                            </div>
                            <p class="text-gray-700">${f.comments}</p>
                            <span class="text-xs px-2 py-1 rounded-full ${getSentimentBadgeClass(f.sentiment_class)} mt-2 inline-block">
                                ${f.sentiment_class}
                            </span>
                        </div>
                    `).join('');
                }

            } catch (error) {
                console.error('Error loading feedback analysis:', error);
            }
        }

        // Load volunteer requests
        async function loadVolunteerRequests() {
            // Simulate getting all volunteer applications from localStorage
            // In a real app, this would come from the backend API
            
            // Get all applications from localStorage
            const applications = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('volunteerApplications')) {
                    const apps = JSON.parse(localStorage.getItem(key) || '[]');
                    applications.push(...apps);
                }
            }
            
            // Also check for individual user applications
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('volunteerStatus_')) {
                    const username = key.replace('volunteerStatus_', '');
                    const status = localStorage.getItem(key);
                    
                    // Only show pending applications
                    if (status === 'pending') {
                        const app = {
                            username: username,
                            fullname: localStorage.getItem(`userFullName_${username}`) || username,
                            status: status,
                            applied_date: localStorage.getItem(`volunteerAppliedDate_${username}`) || new Date().toISOString(),
                            motivation: localStorage.getItem(`volunteerMotivation_${username}`) || 'No motivation provided',
                            preferred_regions: localStorage.getItem(`volunteerRegions_${username}`) || 'Not specified',
                            preferred_categories: localStorage.getItem(`volunteerCategories_${username}`) || 'Not specified'
                        };
                        applications.push(app);
                    }
                }
            }
            
            // Separate applications by status
            const pending = applications.filter(app => app.status === 'pending');
            const approved = applications.filter(app => app.status === 'approved');
            const rejected = applications.filter(app => app.status === 'rejected');
            
            // Update counts
            document.getElementById('pendingCount').textContent = pending.length;
            document.getElementById('approvedCount').textContent = approved.length;
            document.getElementById('rejectedCount').textContent = rejected.length;
            
            // Load pending applications
            const pendingContainer = document.getElementById('pendingApplications');
            if (pending.length === 0) {
                pendingContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No pending applications</p>';
            } else {
                pendingContainer.innerHTML = pending.map(app => `
                    <div class="border rounded-lg p-4 mb-4 bg-gray-50">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-gray-800">${app.fullname || app.username}</h4>
                                <p class="text-sm text-gray-600">@${app.username}</p>
                            </div>
                            <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm">Pending</span>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-gray-700 mb-2"><strong>Motivation:</strong> ${app.motivation}</p>
                            <p class="text-gray-700 mb-2"><strong>Preferred Regions:</strong> ${app.preferred_regions}</p>
                            <p class="text-gray-700 mb-2"><strong>Preferred Categories:</strong> ${app.preferred_categories}</p>
                            <p class="text-sm text-gray-500">Applied: ${new Date(app.applied_date).toLocaleString()}</p>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="approveVolunteer('${app.username}')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex items-center">
                                <i class="fas fa-check mr-2"></i>Approve
                            </button>
                            <button onclick="rejectVolunteer('${app.username}')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 flex items-center">
                                <i class="fas fa-times mr-2"></i>Reject
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            // Load approved volunteers
            const approvedContainer = document.getElementById('approvedVolunteers');
            if (approved.length === 0) {
                approvedContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No approved volunteers</p>';
            } else {
                approvedContainer.innerHTML = approved.map(vol => `
                    <div class="flex justify-between items-center p-4 border rounded-lg bg-green-50">
                        <div>
                            <h4 class="font-bold text-gray-800">${vol.fullname || vol.username}</h4>
                            <p class="text-sm text-gray-600">@${vol.username}</p>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">Approved</span>
                            <p class="text-sm text-gray-500 mt-1">${new Date(vol.approved_date).toLocaleDateString()}</p>
                        </div>
                    </div>
                `).join('');
            }
            
            // Load rejected applications
            const rejectedContainer = document.getElementById('rejectedApplications');
            if (rejected.length === 0) {
                rejectedContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No rejected applications</p>';
            } else {
                rejectedContainer.innerHTML = rejected.map(app => `
                    <div class="border rounded-lg p-4 mb-4 bg-red-50">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-gray-800">${app.fullname || app.username}</h4>
                                <p class="text-sm text-gray-600">@${app.username}</p>
                            </div>
                            <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm">Rejected</span>
                        </div>
                        
                        <div class="mb-3">
                            <p class="text-gray-700"><strong>Reason:</strong> ${app.rejection_reason || 'No reason provided'}</p>
                            <p class="text-sm text-gray-500 mt-2">Rejected: ${new Date(app.rejected_date).toLocaleString()}</p>
                        </div>
                        
                        <button onclick="reconsiderApplication('${app.username}')" class="text-blue-600 hover:text-blue-800 text-sm flex items-center">
                            <i class="fas fa-redo mr-1"></i>Reconsider Application
                        </button>
                    </div>
                `).join('');
            }
        }

        // Helper functions
        function getRoleBadgeClass(role) {
            const classes = {
                admin: 'bg-purple-100 text-purple-800',
                user: 'bg-blue-100 text-blue-800',
                volunteer: 'bg-green-100 text-green-800'
            };
            return classes[role] || 'bg-gray-100 text-gray-800';
        }

        function getSentimentBadgeClass(sentiment) {
            const classes = {
                positive: 'bg-green-100 text-green-800',
                neutral: 'bg-gray-100 text-gray-800',
                negative: 'bg-red-100 text-red-800'
            };
            return classes[sentiment] || 'bg-gray-100 text-gray-800';
        }

        // Volunteer approval/rejection
        async function approveVolunteer(username) {
            if (confirm(`Are you sure you want to approve ${username} as a volunteer?`)) {
                try {
                    // Update user's volunteer status in localStorage
                    localStorage.setItem(`volunteerStatus_${username}`, 'approved');
                    localStorage.setItem(`volunteerApprovedDate_${username}`, new Date().toISOString());
                    
                    // In a real app, you would also update the backend
                    
                    alert(`${username} has been approved as a volunteer!`);
                    loadVolunteerRequests(); // Reload the volunteer requests
                } catch (error) {
                    console.error('Error approving volunteer:', error);
                    alert('Error approving volunteer. Please try again.');
                }
            }
        }

        async function rejectVolunteer(username) {
            const notes = prompt('Enter rejection reason:');
            if (!notes) return;
            
            if (confirm(`Are you sure you want to reject ${username}'s volunteer application?`)) {
                try {
                    // Update user's volunteer status in localStorage
                    localStorage.setItem(`volunteerStatus_${username}`, 'rejected');
                    localStorage.setItem(`volunteerRejectionReason_${username}`, notes);
                    localStorage.setItem(`volunteerRejectedDate_${username}`, new Date().toISOString());
                    
                    // In a real app, you would also update the backend
                    
                    alert(`${username}'s volunteer application has been rejected.`);
                    loadVolunteerRequests(); // Reload the volunteer requests
                } catch (error) {
                    console.error('Error rejecting volunteer:', error);
                    alert('Error rejecting volunteer. Please try again.');
                }
            }
        }

        // Reconsider rejected application
        async function reconsiderApplication(username) {
            if (confirm(`Reconsider ${username}'s volunteer application? This will move it back to pending status.`)) {
                try {
                    // Reset user's volunteer status to pending
                    localStorage.setItem(`volunteerStatus_${username}`, 'pending');
                    localStorage.removeItem(`volunteerRejectionReason_${username}`);
                    
                    alert(`${username}'s application is now pending review.`);
                    loadVolunteerRequests(); // Reload the volunteer requests
                } catch (error) {
                    console.error('Error reconsidering application:', error);
                    alert('Error reconsidering application. Please try again.');
                }
            }
        }

        // Load initial data
        loadDashboardMetrics();
    </script>
</body>
</html>
